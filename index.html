<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>1~25 íƒ€ì„ì–´íƒ</title>
  <style>
    :root { --gap: 10px; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      background: #0b0c10;
      color: #e9eef6;
    }
    .app {
      max-width: 420px;              /* ëª¨ë°”ì¼ í­ ëŠë‚Œ */
      margin: 0 auto;
      min-height: 100svh;
      padding: 16px 16px 24px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .card {
      background: #121522;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }
    .top {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .stat h3 {
      margin: 0 0 6px;
      font-size: 12px;
      opacity: 0.75;
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    .stat .value {
      font-size: 22px;
      font-weight: 800;
    }
    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    button.ctrl {
      appearance: none;
      border: 0;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 800;
      background: #6d5efc;
      color: white;
      cursor: pointer;
    }
    button.ctrl:active { transform: translateY(1px); }
    button.ctrl.secondary {
      background: rgba(255,255,255,0.12);
    }

    .hint {
      font-size: 12px;
      opacity: 0.8;
      line-height: 1.4;
      margin: 0;
    }

    .gridWrap { flex: 1; display: flex; }
    .grid {
      width: 100%;
      aspect-ratio: 1 / 1;           /* ì •ì‚¬ê°í˜• ë³´ë“œ */
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: var(--gap);
    }

    .cell {
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: #171a2a;
      color: #e9eef6;
      font-weight: 900;
      font-size: clamp(14px, 4.2vw, 20px);
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
    }
    .cell:active { transform: scale(0.99); }

    .cell.done {
      opacity: 0.35;
      background: rgba(255,255,255,0.06);
    }
    .cell.next {
      outline: 3px solid rgba(109,94,252,0.85);
      outline-offset: 0px;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(20,22,32,0.95);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 160ms ease;
      max-width: 92vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="card stat">
        <h3>í˜„ì¬ ì‹œê°„</h3>
        <div class="value" id="timeNow">0.00s</div>
      </div>
      <div class="card stat">
        <h3>ìµœê³  ê¸°ë¡</h3>
        <div class="value" id="timeBest">--</div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="ctrl" id="btnRestart">ë¦¬ì…‹/ì„ê¸°</button>
          <button class="ctrl secondary" id="btnHow">ê·œì¹™</button>
        </div>
        <div style="font-weight:900;">
          ë‹¤ìŒ ìˆ«ì: <span id="nextNum">1</span>
        </div>
      </div>
      <p class="hint" id="hint">
        1ë¶€í„° 25ê¹Œì§€ ìˆœì„œëŒ€ë¡œ ëˆŒëŸ¬ë³´ì„¸ìš”. ì˜¤ë‹µì„ ëˆ„ë¥´ë©´ <b>1ë¶€í„° ë‹¤ì‹œ</b> ì‹œì‘í•©ë‹ˆë‹¤.
      </p>
    </div>

    <div class="gridWrap card">
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    /*********************
     *  Firebase ì„¤ì • (ë„ˆ í”„ë¡œì íŠ¸ë¡œ ë°”ê¿”ì¤˜!)
     *********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /*********************
     *  ê²Œì„ ë¡œì§
     *********************/
    const gridEl = document.getElementById("grid");
    const timeNowEl = document.getElementById("timeNow");
    const timeBestEl = document.getElementById("timeBest");
    const nextNumEl = document.getElementById("nextNum");
    const toastEl = document.getElementById("toast");

    const btnRestart = document.getElementById("btnRestart");
    const btnHow = document.getElementById("btnHow");

    const LS_BEST = "numberGame_bestMs_v1";
    const LS_DEVICE = "numberGame_deviceId_v1";

    const state = {
      next: 1,
      started: false,
      startAt: 0,
      raf: 0,
      bestMs: null,
      numbers: [],
      doneSet: new Set(),
      completed: false,
    };

    function getDeviceId() {
      let id = localStorage.getItem(LS_DEVICE);
      if (!id) {
        // ê°„ë‹¨í•œ ëœë¤ ID (ê¸°ê¸°/ë¸Œë¼ìš°ì € ë‹¨ìœ„)
        id = "dev_" + Math.random().toString(36).slice(2) + "_" + Date.now().toString(36);
        localStorage.setItem(LS_DEVICE, id);
      }
      return id;
    }

    function formatMs(ms) {
      const s = ms / 1000;
      return s.toFixed(2) + "s";
    }

    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toastEl.classList.remove("show"), 1200);
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function loadBest() {
      const v = localStorage.getItem(LS_BEST);
      state.bestMs = v ? Number(v) : null;
      timeBestEl.textContent = state.bestMs ? formatMs(state.bestMs) : "--";
    }

    function saveBestLocal(ms) {
      localStorage.setItem(LS_BEST, String(ms));
      state.bestMs = ms;
      timeBestEl.textContent = formatMs(ms);
    }

    function stopTimer() {
      cancelAnimationFrame(state.raf);
      state.raf = 0;
    }

    function tick() {
      if (!state.started) return;
      const now = performance.now();
      const ms = now - state.startAt;
      timeNowEl.textContent = formatMs(ms);
      state.raf = requestAnimationFrame(tick);
    }

    function startTimerIfNeeded() {
      if (state.started) return;
      state.started = true;
      state.startAt = performance.now();
      tick();
    }

    function resetGame({ reshuffle = true } = {}) {
      stopTimer();
      state.started = false;
      state.startAt = 0;
      timeNowEl.textContent = "0.00s";

      state.next = 1;
      state.completed = false;
      state.doneSet = new Set();

      nextNumEl.textContent = String(state.next);

      const nums = Array.from({ length: 25 }, (_, i) => i + 1);
      state.numbers = reshuffle ? shuffle(nums) : nums; // ê¸°ë³¸ì€ ì„ê¸°
      renderGrid();
    }

    function renderGrid() {
      gridEl.innerHTML = "";
      for (const n of state.numbers) {
        const btn = document.createElement("div");
        btn.className = "cell";
        btn.textContent = String(n);
        btn.dataset.num = String(n);

        // ë‹¤ìŒ ëˆŒëŸ¬ì•¼ í•  ìˆ«ì ê°•ì¡°(í˜„ì¬ ê·¸ ìˆ«ìê°€ ì•„ì§ ì•ˆ ëˆŒë¦° ìƒíƒœì¼ ë•Œ)
        if (n === state.next) btn.classList.add("next");

        btn.addEventListener("click", () => onPressNumber(n));
        gridEl.appendChild(btn);
      }
    }

    function updateCellStyles() {
      const cells = gridEl.querySelectorAll(".cell");
      cells.forEach((c) => {
        const n = Number(c.dataset.num);

        c.classList.toggle("done", state.doneSet.has(n));
        c.classList.toggle("next", n === state.next && !state.doneSet.has(n));
      });
    }

    async function onFinish(finalMs) {
      stopTimer();
      state.completed = true;

      const isNewBest = state.bestMs == null || finalMs < state.bestMs;

      if (isNewBest) {
        saveBestLocal(finalMs);
        showToast("ğŸ‰ ì‹ ê¸°ë¡! " + formatMs(finalMs));
      } else {
        showToast("ì™„ë£Œ! " + formatMs(finalMs));
      }

      // Firestore ì €ì¥ (ì‹ ê¸°ë¡ì¼ ë•Œë§Œ ì—…ë°ì´íŠ¸)
      if (isNewBest) {
        const deviceId = getDeviceId();
        const ref = doc(db, "number_score", deviceId);

        try {
          await setDoc(ref, {
            deviceId,
            bestMs: finalMs,
            bestSec: Number((finalMs / 1000).toFixed(2)),
            updatedAt: serverTimestamp(),
            game: "number_1to25",
          }, { merge: true });

          // showToast("í´ë¼ìš°ë“œ ì €ì¥ë¨");
        } catch (err) {
          console.error(err);
          showToast("ì €ì¥ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)");
        }
      }
    }

    function onPressNumber(n) {
      if (state.completed) return;

      // ì •ë‹µì´ë©´ ì§„í–‰
      if (n === state.next) {
        // íƒ€ì´ë¨¸ëŠ” 1ë²ˆì„ ì²˜ìŒ ëˆŒë €ì„ ë•Œ ì‹œì‘
        if (n === 1) startTimerIfNeeded();

        state.doneSet.add(n);
        state.next += 1;
        nextNumEl.textContent = state.next <= 25 ? String(state.next) : "ì™„ë£Œ!";
        updateCellStyles();

        if (n === 25) {
          const finalMs = performance.now() - state.startAt;
          timeNowEl.textContent = formatMs(finalMs);
          onFinish(finalMs);
        }
        return;
      }

      // ì˜¤ë‹µì´ë©´: "ì²˜ìŒë¶€í„°" (ì‹œê°„ í˜ë„í‹° ì—†ìŒ = ì¶”ê°€ ê°€ì‚° ì—†ìŒ)
      // ì—¬ê¸°ì„œëŠ” ì§„í–‰ë§Œ 1ë¡œ ë¦¬ì…‹, íƒ€ì´ë¨¸ëŠ” ê³„ì† íë¥´ê²Œ(ë²Œì  ì—†ì´) ìœ ì§€
      // ì›í•˜ë©´ "íƒ€ì´ë¨¸ë„ ë¦¬ì…‹"ìœ¼ë¡œ ë°”ê¿€ ìˆ˜ë„ ìˆì–´.
      state.doneSet.clear();
      state.next = 1;
      nextNumEl.textContent = "1";
      updateCellStyles();
      showToast("ì˜¤ë‹µ! 1ë¶€í„° ë‹¤ì‹œ");
    }

    btnRestart.addEventListener("click", () => {
      resetGame({ reshuffle: true });
      showToast("ë¦¬ì…‹ & ì„ê¸°");
    });

    btnHow.addEventListener("click", () => {
      showToast("1â†’25 ìˆœì„œ í´ë¦­! ì˜¤ë‹µì´ë©´ 1ë¶€í„° ë‹¤ì‹œ");
    });

    // ì´ˆê¸°í™”
    loadBest();
    resetGame({ reshuffle: true });
    getDeviceId();
  </script>
</body>
</html>
